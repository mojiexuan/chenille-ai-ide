name: Chenille AI IDE Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      platform:
        description: "构建平台"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - linux
          - darwin
          - win32

permissions:
  contents: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build-linux:
    if: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'linux' || github.event_name == 'push' }}
    name: Linux x64
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: "npm"

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: ~/.cache/electron
          key: electron-linux-x64-${{ hashFiles('package.json') }}
          restore-keys: electron-linux-x64-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libx11-dev libx11-xcb-dev \
            libxkbfile-dev libsecret-1-dev libkrb5-dev libgbm-dev rpm fakeroot

      - name: Install dependencies
        run: npm ci
        env:
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Download Electron
        run: npm run electron x64
        timeout-minutes: 20

      - name: Download built-in extensions
        run: node build/lib/builtInExtensions.ts
        timeout-minutes: 20

      - name: Build
        run: npm run gulp vscode-linux-x64-min
        timeout-minutes: 90
        env:
          NODE_OPTIONS: "--max-old-space-size=6144"

      - name: Package deb
        run: npm run gulp vscode-linux-x64-build-deb
        timeout-minutes: 20

      - name: Package rpm
        run: npm run gulp vscode-linux-x64-build-rpm
        timeout-minutes: 20

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chenille-linux-x64
          path: |
            .build/linux/deb/**/*.deb
            .build/linux/rpm/**/*.rpm
          if-no-files-found: warn

  build-macos-x64:
    if: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'darwin' || github.event_name == 'push' }}
    name: macOS x64
    runs-on: macos-13
    timeout-minutes: 180
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: "npm"

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/electron
          key: electron-darwin-x64-${{ hashFiles('package.json') }}
          restore-keys: electron-darwin-x64-

      - name: Install Python setuptools
        run: python3 -m pip install --break-system-packages setuptools

      - name: Install dependencies
        run: npm ci
        env:
          npm_config_arch: x64
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Download Electron
        run: npm run electron x64
        timeout-minutes: 20

      - name: Download built-in extensions
        run: node build/lib/builtInExtensions.ts
        timeout-minutes: 20

      - name: Build
        run: npm run gulp vscode-darwin-x64-min
        timeout-minutes: 90

      - name: Package DMG
        run: npm run gulp vscode-darwin-x64-build-dmg
        timeout-minutes: 30

      - name: Upload macOS x64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chenille-darwin-x64
          path: .build/**/*.dmg
          if-no-files-found: warn

  build-macos-arm64:
    if: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'darwin' || github.event_name == 'push' }}
    name: macOS arm64
    runs-on: macos-14
    timeout-minutes: 180
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: "npm"

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/electron
          key: electron-darwin-arm64-${{ hashFiles('package.json') }}
          restore-keys: electron-darwin-arm64-

      - name: Install Python setuptools
        run: python3 -m pip install --break-system-packages setuptools

      - name: Install dependencies
        run: npm ci
        env:
          npm_config_arch: arm64
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Download Electron
        run: npm run electron arm64
        timeout-minutes: 20

      - name: Download built-in extensions
        run: node build/lib/builtInExtensions.ts
        timeout-minutes: 20

      - name: Build
        run: npm run gulp vscode-darwin-arm64-min
        timeout-minutes: 90

      - name: Package DMG
        run: npm run gulp vscode-darwin-arm64-build-dmg
        timeout-minutes: 30

      - name: Upload macOS arm64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chenille-darwin-arm64
          path: .build/**/*.dmg
          if-no-files-found: warn

  build-windows:
    if: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'win32' || github.event_name == 'push' }}
    name: Windows x64
    runs-on: windows-latest
    timeout-minutes: 180
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: "npm"

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: ~/AppData/Local/electron/Cache
          key: electron-win32-x64-${{ hashFiles('package.json') }}
          restore-keys: electron-win32-x64-

      - name: Install dependencies
        run: npm ci
        env:
          npm_config_arch: x64
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Download Electron
        run: npm run electron x64
        timeout-minutes: 20

      - name: Download built-in extensions
        run: node build/lib/builtInExtensions.ts
        timeout-minutes: 20

      - name: Build
        run: npm run gulp vscode-win32-x64-min
        timeout-minutes: 90

      - name: Package Setup Installer (Inno Setup)
        run: npm run gulp vscode-win32-x64-inno-updater
        timeout-minutes: 20

      - name: Package System Installer
        run: npm run gulp vscode-win32-x64-system-setup
        timeout-minutes: 20

      - name: Package User Installer
        run: npm run gulp vscode-win32-x64-user-setup
        timeout-minutes: 20

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chenille-win32-x64
          path: .build/win32-x64/**/*.exe
          if-no-files-found: warn

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-macos-x64, build-macos-arm64, build-windows]
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Chenille AI IDE ${{ github.ref_name }}
          draft: true
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          files: |
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.dmg
            artifacts/**/*.exe
          body: |
            ## Chenille AI IDE ${{ github.ref_name }}

            ### 下载
            - **Windows**: 下载 `.exe` 安装包
            - **macOS Intel**: 下载 `x64.dmg`
            - **macOS Apple Silicon**: 下载 `arm64.dmg`
            - **Linux**: 下载 `.deb` (Debian/Ubuntu) 或 `.rpm` (Fedora/RHEL)

            ### 更新日志
            请查看 [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
